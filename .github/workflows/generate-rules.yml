name: Generate freee Auto Rules

on:
  workflow_dispatch:
    inputs:
      output_format:
        description: 'å‡ºåŠ›å½¢å¼'
        required: false
        default: 'csv'
        type: choice
        options:
          - csv
          - csv_and_guide

jobs:
  generate-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Generate freee auto-bookkeeping rules
      env:
        FREEE_ACCESS_TOKEN: ${{ secrets.FREEE_ACCESS_TOKEN }}
        FREEE_COMPANY_ID: ${{ secrets.FREEE_COMPANY_ID }}
      run: |
        echo "=== freeeè‡ªå‹•ä»•è¨³ãƒ«ãƒ¼ãƒ«ç”Ÿæˆ ==="
        echo "å…¨æœŸé–“ã®å–å¼•ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¾ã™..."
        python src/setup_freee_rules.py
    
    - name: Upload generated files
      uses: actions/upload-artifact@v4
      with:
        name: freee-auto-rules-${{ github.run_id }}
        path: |
          freee_auto_rules_*.csv
          freee_rules_implementation_guide.md
        retention-days: 30
    
    - name: Display summary
      run: |
        echo "## ğŸ“Š ç”Ÿæˆå®Œäº†"
        echo ""
        echo "ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
        ls -la freee_auto_rules_*.csv
        echo ""
        echo "### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
        echo "1. ä¸Šè¨˜ã®Artifactsã‹ã‚‰CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
        echo "2. freeeã®ã€Œè‡ªå‹•ã§çµŒç†ã€è¨­å®šç”»é¢ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"
        echo "3. é«˜ä¿¡é ¼åº¦ã®ãƒ«ãƒ¼ãƒ«ã‹ã‚‰é †ã«ç™»éŒ²"
        echo ""
        if [ -f freee_rules_implementation_guide.md ]; then
          echo "### å®Ÿè£…ã‚¬ã‚¤ãƒ‰ã®å†…å®¹:"
          head -20 freee_rules_implementation_guide.md
        fi