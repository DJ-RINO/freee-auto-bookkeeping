name: Claude Auto Fix System

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  claude-auto-fix:
    if: contains(github.event.issue.body, '@claude') || contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install anthropic requests PyYAML
          
      - name: Claude Auto Fix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REQUEST_TEXT: ${{ github.event.issue.body || github.event.comment.body }}
          REPO_NAME: ${{ github.repository }}
        run: |
          python << 'EOF'
          import os
          import subprocess
          import json
          from anthropic import Anthropic

          # è¨­å®š
          api_key = os.getenv('ANTHROPIC_API_KEY')
          issue_number = os.getenv('ISSUE_NUMBER')
          request_text = os.getenv('REQUEST_TEXT', '')
          repo_name = os.getenv('REPO_NAME')

          print(f"ðŸ¤– Claude Auto Fix System - Issue #{issue_number}")
          print(f"ðŸ“‹ Request: {request_text[:100]}...")

          if not api_key:
              print("âŒ ANTHROPIC_API_KEY not found")
              exit(1)

          try:
              # Claude APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
              client = Anthropic(api_key=api_key)
              
              # freeeè‡ªå‹•çµŒç†ã‚·ã‚¹ãƒ†ãƒ ã®å•é¡Œåˆ†æžãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
              system_prompt = """
              ã‚ãªãŸã¯freeeè‡ªå‹•çµŒç†ã‚·ã‚¹ãƒ†ãƒ ã®å°‚é–€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚
              GitHub Actionsã®ãƒ­ã‚°ã‚’åˆ†æžã—ã€ä»¥ä¸‹ã®å•é¡Œã‚’è‡ªå‹•ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š
              
              1. å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã®éŽå‰°åå¿œï¼ˆ"None"ãƒžãƒƒãƒãƒ³ã‚°ï¼‰
              2. ãƒžãƒƒãƒãƒ³ã‚°é–¾å€¤ã®ç¾å®Ÿçš„èª¿æ•´
              3. è‡ªå‹•ç´ä»˜ã‘çŽ‡ã®å‘ä¸Šï¼ˆ0%â†’20%ä»¥ä¸Šï¼‰
              4. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å‰Šæ¸›
              
              å…·ä½“çš„ãªä¿®æ­£æ‰‹é †ã¨ã‚³ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
              """
              
              user_prompt = f"""
              freeeè‡ªå‹•çµŒç†ã‚·ã‚¹ãƒ†ãƒ ã§ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ï¼š
              
              {request_text}
              
              é–¢é€£GitHub Actions: https://github.com/{repo_name}/actions
              
              ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¦å•é¡Œã‚’è§£æ±ºã—ã¦ãã ã•ã„ï¼š
              - src/matcher.py (å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ æ”¹å–„)
              - config/linking.yml (é–¾å€¤èª¿æ•´)
              - src/vendor_mapping_learner.py (ãƒ‡ãƒ¼ã‚¿å“è³ªå‘ä¸Š)
              
              å…·ä½“çš„ãªä¿®æ­£ã‚³ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
              """

              # Claude APIã§ä¿®æ­£æ¡ˆã‚’å–å¾—
              response = client.messages.create(
                  model="claude-3-5-sonnet-20241022",
                  max_tokens=4000,
                  messages=[
                      {"role": "user", "content": system_prompt + "\n\n" + user_prompt}
                  ]
              )
              
              fix_suggestion = response.content[0].text
              print("âœ… Claudeä¿®æ­£æ¡ˆ:")
              print(fix_suggestion)
              
              # GitHub Issue ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ä¿®æ­£æ¡ˆã‚’æŠ•ç¨¿
              import requests
              
              comment_body = f"""
              ## ðŸ¤– Claude Auto Fix Analysis
              
              Issue #{issue_number} ã®å•é¡Œã‚’åˆ†æžã—ã¾ã—ãŸã€‚
              
              ### ðŸ“Š å•é¡Œç‰¹å®š
              - å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã® "None" éŽå‰°åå¿œ
              - ãƒžãƒƒãƒãƒ³ã‚°é–¾å€¤ãŒé«˜ã™ãŽã‚‹ (70ç‚¹)
              - è‡ªå‹•ç´ä»˜ã‘çŽ‡: 0%
              
              ### ðŸ› ï¸ ä¿®æ­£ææ¡ˆ
              {fix_suggestion}
              
              ### ðŸš€ å®Ÿè¡Œæ–¹æ³•
              ä¸Šè¨˜ã®ä¿®æ­£ã‚’é©ç”¨ã™ã‚‹ã«ã¯ã€æ–°ã—ã„Pull Requestã‚’ä½œæˆã—ã¾ã™ã€‚
              
              ---
              Generated with Claude Auto Fix System
              """
              
              # GitHub APIã§ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
              github_token = os.getenv('GITHUB_TOKEN')
              headers = {
                  'Authorization': f'token {github_token}',
                  'Accept': 'application/vnd.github.v3+json'
              }
              
              comment_url = f"https://api.github.com/repos/{repo_name}/issues/{issue_number}/comments"
              comment_data = {"body": comment_body}
              
              response = requests.post(comment_url, headers=headers, json=comment_data)
              
              if response.status_code == 201:
                  print("âœ… GitHub Issue ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿å®Œäº†")
              else:
                  print(f"âŒ ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿å¤±æ•—: {response.status_code}")
              
          except Exception as e:
              print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
              exit(1)
          EOF