name: Claude Code Action

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, edited]

jobs:
  claude-response:
    # @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if: contains(github.event.comment.body, '@claude') || contains(github.event.issue.body, '@claude')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install Claude Code CLI
        run: |
          # Claude Code CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã¯æœ€æ–°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¾“ã£ã¦æ›´æ–°ãŒå¿…è¦
          pip install anthropic
          
      - name: Process Claude request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_BODY: ${{ github.event.comment.body || github.event.issue.body }}
        run: |
          echo "Processing Claude Code Action request..."
          echo "Issue Number: $ISSUE_NUMBER"
          echo "Request: $COMMENT_BODY"
          
          # Claude Code CLIã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰åˆ†æãƒ»ä¿®æ­£ã‚’å®Ÿè¡Œ
          # å®Ÿéš›ã®Claude Code Action APIãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ãŸã‚‰é©åˆ‡ãªã‚³ãƒãƒ³ãƒ‰ã«ç½®ãæ›ãˆ
          python -c "
          import os
          import json
          from anthropic import Anthropic
          
          client = Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))
          
          # Issue/Commentã®å†…å®¹ã‚’è§£æã—ã¦ã‚¿ã‚¹ã‚¯ã‚’ç‰¹å®š
          request_text = os.getenv('COMMENT_BODY', '')
          issue_number = os.getenv('ISSUE_NUMBER', '')
          
          # Claudeã«ã‚¿ã‚¹ã‚¯ã‚’ä¾é ¼
          response = client.messages.create(
              model='claude-3-sonnet-20240229',
              max_tokens=4000,
              messages=[{
                  'role': 'user', 
                  'content': f'GitHub Issue #{issue_number}ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: {request_text}\n\nfreeeè‡ªå‹•çµŒç†ã‚·ã‚¹ãƒ†ãƒ ã®ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚å…·ä½“çš„ãªä¿®æ­£æ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚'
              }]
          )
          
          print('Claude Response:')
          print(response.content[0].text)
          "
          
      - name: Create Pull Request if changes made
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: Claude Code Actionã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£"
          title: "Claude Code Action: Issue #${{ github.event.issue.number }}ã¸ã®å¯¾å¿œ"
          body: |
            ## Claude Code Actionã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£
            
            Issue #${{ github.event.issue.number }} ã®ä»¥ä¸‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾å¿œã—ã¾ã—ãŸï¼š
            
            ```
            ${{ github.event.comment.body || github.event.issue.body }}
            ```
            
            ### ä¿®æ­£å†…å®¹
            - è‡ªå‹•çš„ã«ã‚³ãƒ¼ãƒ‰åˆ†æã¨ä¿®æ­£ã‚’å®Ÿè¡Œ
            - é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æ›´æ–°
            - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€é©åŒ–
            
            ğŸ¤– Generated with Claude Code Action
          branch: claude-code-action-${{ github.event.issue.number }}
          delete-branch: true