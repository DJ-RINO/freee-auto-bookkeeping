# マッチングアルゴリズム改善提案（TDD和田流）

## 現在の問題点

### 1. 日付マッチングが実用的でない
**現在の設定:**
- 許容日数: 3日
- ウェイト: 25%（0.25）

**問題:**
- 請求書発行日と実際の振込日は1ヶ月以上ずれることが普通
- レシート例: コーヒーローストビバーチェ 2025-03-01 vs 取引 2025-05-02（60日差）
- 結果: 完全に0点でマッチング不可

### 2. 金額マッチングが厳密すぎる
**現在の設定:**
- 許容金額差: 1円
- ウェイト: 40%（0.4）

**問題:**
- 振込手数料、税込/税抜の差異を考慮していない
- レシート例: ¥27,060 vs 取引 ¥26,130（930円差）→ 0点
- 結果: わずかな差で完全に除外

### 3. 前段フィルターが厳しすぎる
**現在の設定:**
- 最低類似度: 0.6（60%）

**問題:**
- 銀行振込の表記（「振込 カ）」など）と正式名称の差
- レシート: "株式会社コーヒーローストビバーチェ"
- 取引: "振込 カ）コ−ヒ−ロ−ストビバ−チエ"
- 類似度: 0.69 → かろうじてクリア

## 改善提案

### 1. 日付許容範囲を大幅拡大
```python
# 現在
tol["days"] = 3

# 提案
tol["days"] = 45  # 1.5ヶ月の許容範囲
```

### 2. 金額許容範囲を実用的に調整
```python
# 現在
tol["amount_jpy"] = 1

# 提案
tol["amount_jpy"] = max(1000, amount * 0.05)  # 1000円または5%の大きい方
```

### 3. 前段フィルター緩和
```python
# 現在
min_sim = 0.6

# 提案
min_sim = 0.3  # 30%で初期フィルタリング
```

### 4. ウェイト調整
```python
# 現在
weights = {"amount": 0.4, "date": 0.25, "name": 0.3, "tax_rate": 0.05}

# 提案（日付の重要度を下げる）
weights = {"amount": 0.5, "date": 0.1, "name": 0.35, "tax_rate": 0.05}
```

## 期待される効果

### 成功ケース予測
1. **コーヒーローストビバーチェ**: 
   - 名前: 69点
   - 金額: 0点 → 90点（5%許容）
   - 日付: 0点 → 100点（45日許容）
   - **総合: 20点 → 82点**

2. **ヤマト運輸**: 
   - 名前: 100点
   - 金額: 0点 → 80点
   - 日付: 100点（同日）
   - **総合: 30点 → 95点**

### マッチング成功率の向上
- 現在: 0/50件
- 予測: 15-20/50件（30-40%の成功率）