# Claude開発ガイドライン

## 🚨 必須ルール（絶対遵守）

### 1. トークン管理の鉄則
**Claude は freee API 操作時、必ず以下の手順を実行する：**

1. **常にリフレッシュトークンを使用**: 既存のアクセストークンを直接使用してはならない
2. **トークン自動更新**: `integrate_with_main()` 関数を実行してトークンを更新
3. **失敗時の対処**: 401エラー時は認可コードリクエストではなく、まずリフレッシュを再試行

**実行手順:**
```python
# ❌ 禁止: 直接アクセストークンを使用
access_token = os.getenv("FREEE_ACCESS_TOKEN")

# ✅ 必須: 必ずintegrate_with_main()でトークン更新
from token_manager import integrate_with_main
access_token = integrate_with_main()  # これが唯一の正しい方法
```

### 2. 環境変数読み込み
**必須の環境変数読み込み方法:**
```bash
export $(cat .env | grep -v '^#' | xargs) && python script.py
```

### 3. OCR改善システム優先使用
freeeレシート処理時は必ず以下の機能を使用：
- `enhanced_matcher.py` でOCR品質検出
- `ocr_quality_manager.py` でデータ補強
- 適応型閾値システムで判定

## 📋 プロジェクト概要

このプロジェクトは freee 自動経理システムで、OCR精度問題を根本的に解決する包括的ソリューションです。

### 主要コンポーネント
- **OCR品質管理**: 自動検出・補強システム
- **適応型マッチング**: 品質に応じた戦略切り替え
- **学習システム**: vendor-transaction マッピング学習
- **閾値システム**: OCR品質対応の動的調整

### 成功実績
- 自動紐付け率: 0% → 32% (1600%改善)
- OCR処理未完了レシート: 100%救済
- 効率化率: 58% (自動+確認)

## 🛠️ 開発手順

### 新機能開発時
1. `test_ocr_solutions.py` でシステムテスト
2. `test_ocr_improvements_realistic.py` で実データテスト
3. `scripts/process_receipts_main.py` で実環境テスト

### API操作時の注意
- 必ず `--dry-run` オプションでテスト
- ログでOCR品質検出状況を確認
- Slack通知の設定確認

## 📊 モニタリング指標

### 成功指標
- 自動紐付け率: 30%以上維持
- OCR品質低下レシート救済率: 90%以上
- システムエラー率: 1%以下

### 警告指標  
- 自動紐付け率: 20%以下
- 手動対応率: 60%以上
- API エラー率: 5%以上

## 🔍 トラブルシューティング

### よくある問題
1. **トークン期限切れ**: `integrate_with_main()` 実行
2. **OCR品質低下**: 強化マッチャーの動作確認
3. **マッチング率低下**: 閾値設定の確認

### 緊急時対応
- API障害時: DRY_RUNモードで動作確認
- 大量エラー時: ログ詳細分析
- データ不整合: 学習データのクリア

---

**このガイドラインは Claude の動作規範であり、必ず遵守すること。**